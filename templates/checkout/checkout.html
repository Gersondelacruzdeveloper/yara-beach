{% extends 'excursions/excursions_base.html' %}
<title>{% block title %}excursions in bavaro punta cana {% endblock %}</title>
{% load static %}

{% block content %}

<section>
  <div class="container mb-2">
    <h1 class="text-center mt-5">Checkout</h1>
    <div class="row">
      <!-- what is in the cart -->
      <div class="col-md-4 order-md-2 mb-4">
        <h4 class="d-flex justify-content-between align-items-center mb-3">
          <span class="text-muted">Your cart</span>
          <span class="badge bg-site-color badge-pill">{{cart_items| length}}</span>
        </h4>
        <ul class="list-group mb-3">
          {% for item in cart_items %}
          <li class="list-group-item d-flex justify-content-between lh-condensed">
            <div>
              <h6 class="my-0" style="font-weight: bolder;">{{item.excursion.title|slice:":25"|title}}</h6>
              <div class="pt-3">
                <small><img class="cart-detail-img" src="{{item.excursion.main_image.url}}"
                    alt="{{item.excursion.image_name}}"></small>
              </div>
              {% if item.values.adult_qty %}
              <div class="pt-2"><i class="fa-solid fa-user"></i> Adult: {{item.values.adult_qty}}</div>
              {% endif%}

              {% if item.values.child_qty %}
              <div class="pt-2"> <i class="fa-solid fa-child"></i> Child: {{item.values.child_qty}}</div>
              {% endif%}
              {% if item.values.infant_qty %}
              <i class="fa-solid fa-baby-carriage"></i> <div class="pt-2">Infant: {{item.values.infant_qty}}</div>
              {% endif%}
              <div clas="pt-2">
                <i class="fa-solid fa-calendar-days"></i> Date: {{item.values.excursion_date}}
              </div>
              <div clas="pt-3">
                <i class="fa-solid fa-clock"></i> Time: {{item.values.selected_time}}
              </div>
              <div class="pt-2">
                 <p><i class="fa-solid fa-circle-check" style="color:green;"></i> Free Cancellation</p>
            </div>
            <span class="text-muted">${{item.subTotal | floatformat:2}}</span>
          </li>
      
          <li class="list-group-item d-flex justify-content-between">
            <span>Total (US)</span>
            <strong>${{total | floatformat:2}}</strong>
            <p style="color: green">All taxes and fees included</p>
          </li>

          {% if total_discount != 0%}
          <li class="list-group-item d-flex justify-content-between">
            <span>Discount</span>
            <strong>${{total_discount | floatformat:2}}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Final Total (US)</span>
            <strong>${{new_total | floatformat:2}}</strong>
          </li>
          {% endif%}
  

          <!-- session_discount -->
          <!-- card icons -->
          <div class="text-center list-group-item ">
            <i class="fa fa-cc-visa visa"></i>
            <i class="fa fa-cc-amex amex"></i>
            <i class="fa fa-cc-mastercard mastercard"></i>
            <i class="fa fa-cc-discover discover"></i>
          </div>
        </ul>

        <!-- form for updating quantity-->
        {% if item.excursion.dicount %}
      <form method="POST" action="{% url 'apply_discount' %}">
        {% csrf_token %}
        <div class="col-md-6 mb-3 list-group-item">
          <label for="reference">Discount Code</label>
          <input type="text" class="form-control" id="reference" name="reference" placeholder="Enter Promo code"
            maxlength="6" required>
        </div>
        <div class="col-md-6 mb-3 list-group-item">
          <label for="apply">Apply Discount Code</label>
          <button id="apply" class=" form-control btn my_hover btn-outline-secondary">Apply</button>
        </div>
    </div>
    </form>
    {% endif %}
      </div>
      {% endfor %}

    <!-- card pytments infomation -->
    <div class="col-md-8 order-md-1" style="margin: auto; padding:20px">
      <h4 class="mb-3">Provide your personal information</h4>
      <p style="color:green;"><i class="fa-solid fa-lock"></i> Checkout is fast and secure with <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHcAAAAgCAMAAAAfbBf3AAAAxlBMVEX///8AL4YAnN4BIGkAmt0ALIUAmN0AKoQAldwAJ4MAJ3fj8PoAn+EAJYLj5e0AGn8AIoEAEH0AOI0AouDt8Pbn9Pv29/r3/P4AFH1xgrEAHoDv+v2x3fPCyt3R2OfB4vUBGmU+XJ9nvekBcbOyvdZxyO1fd613kb+Szu4wV54qr+QaSZhkgbaOosdPca0aOX8AAHtGaKcBQoxOuugBEF+h3PQUP4+Gl7+m1PCD0PCfqslMruMAe8DX8PoAZqsBLHYBWJo4ltCTVHCOAAAEo0lEQVRIidWWeXOySBCHGTLDETkMh0TlUIIEvN74ukFFye5+/y+13YNGUGvdyh9WbVcqo804P7rn6Z4RBEFwZoyczMrnifAgS17J2Zj6aoWP0V10Sctk03iEbG+ut3WJvnyIbi5f6JKX3iN0LXal+4hEO0esnk9GiNm5mGKczPHuL+i5nZMNbz3GBzCGte7z07eNfvmt5Z3+xws3k6yS+1tQrZXaJHsdXb9nJCoKhbEcXOo+PSufzZnhSv2uMnNxVzeaUrE2SiX/6vHOpnQKY41zU3b0W5SaGUpyJMAiqM7uV7dvU5Hamobq1L4KeKKJdA1jHUxT94+DKDUDTgpG1P5i07dw5t2AtxjqJMtiDT9El49jUZQmMNY4t7aXitKuMbOEQlMR8TFO3XDfv/CVSSKdAjlDGyP2L6fvKY+qd4nV6OnQ1vU2XcJmqJuibikIRpCUSWAYQRCEXoj/64n40XBjSPParRV4vFXkb/3IdaMoqgQXvEoF0Ly0dUdPXzC9yYPR14m6BF0P4sX9DfqFaZqk359ZJHU2hWXNOOXh2LKsslqD7mRYx0vtoefHtiRJ9iS2bW3nReCVIPzE5LpH0dHo9xu+peKedcOlStQ0NMIStoTlXjLrMiarsiwz1u07SSGzVzzEnPmA6asQcZZ2VVUBQEhQZksUjeOdeZ+Asw2z3/mp8DzC8vnz119fB14A08Z+BdBI2ThNVwTSrJfhTCWytUo55INFzxnLRE8RA53Is6TGeR/HUxFGGkU42Os132xI466Fc/H1BnY4KBqHULnEGSpXB7qYOe8tu0QeJ2EYpOAwAyhErC54vYIx690R/LpyeYDSzsNi3vtV5R93+4RzwXHORY1bXe/StFW+eG7IOphZbAxjQFhRcj/cF7ph/V6DsLeCcIECD3CudalkZ8NIgWg5LFtMcHXCWeDba30dFfm7StNW0WFDY6s0Tftl4AilSeSVUeefsSLEAw3K+30xIHIO0SPOogZ5jidb6JITKKo9X8bHPlVxnGF5g+NsvWniKT2SFrdknXdMbICnglfzoKan/MtjfANM9AyzvIEJFZZRHAFXLk4HuMWYT4d2QmM3Qt3hEWdWHLiuNp1O4yxym7JCmKpE7zunr6DLMC7wA09z1A2Qc/hb4iSOc/a9T1hUe1ywwgSfceaXHDZTeLQZvOXV2RUCr4Dt925Dn7FWZbJYIs4b/j78YijPePfg9Xmu/h3sthZ/+tkeudlCVVGOc8qb/Yz3cO368MBoYFXzfMl0LOS6yKFqAeeEN8B3BN4q622krabckSBg0bZtzvcZZ95yWa7xs+Oqh/MAdVkeBI3vpgo51dWiUGWz9ieom/KUeFuFthbKFA6NiMrgjyWqYA8mMvYdjjNdVzfjzfN83rj49IIlMeVxmaR5ntb+JTs2cND1gZFJgxBwaFRb+/6a+yfwGG8b8OM8X/3Ntze+qdtzwFoevPY4Pe/bv8E76GknPNd1W4iAo+O63tE/hIGvgdZZ8yaW3boO3TcEQJ//5Jcuv5kAbT8x7M+y9R/ue9fWsfEaZt/E+a4tBh8fH8H9ebfM4/az3wo9z3vEPf9/bf8Am4p1OXgAohQAAAAASUVORK5CYII=" alt="paypal img"></p>
      <form action=" " method="POST" id="payment-form">
        {% csrf_token %}
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="full_name">Full name *</label>
            <input onchange="myFunction()" type="text" class="form-control" id="full_name" name="full_name"
              placeholder="Full Name" required>
          </div>

          <div class="col-md-6 mb-3">
            <label for="Phone_number">Phone number</label>
            <input onchange="myFunction()" type="text" class="form-control" id="Phone_number" name="Phone_number"
              placeholder="Phone number" required>
          </div>
          {% if not request.user.is_authenticated %}
          <div class="col-md-12 mb-3">
            <label for="email">Email</label>
            <input onchange="myFunction()" type="text" class="form-control" id="email" name="email"
              placeholder="Email" required>
          </div>
          {%endif%}
          <hr class="mb-4">
          <h4 class="mb-3">Payment</h4>
          <div id="paypal-button-container"></div>
          <p class="p-3"><i class="fa-solid fa-circle-check" style="color:green;"></i> Free Cancellation</p>
          <script>
            // let continues = document.getElementById('continue')
            let paypalBtnId = document.getElementById('paypal-button-container')
            paypalBtnId.style.display = "none"
            // Initialize a counter variable to keep track of the function calls
            let functionCallCount = 0;
            const full_name = document.getElementById('full_name').value;
            const phone_number = document.getElementById('Phone_number').value;
            const email = document.getElementById('email')?.value;
            const get_user = '{{request.user}}'
            function myFunction() {
              functionCallCount++
              if(get_user != 'AnonymousUser'){
                if (functionCallCount == 2) {
                paypalBtnId.style.display = 'block'
              }
              }else{
                if (functionCallCount == 3) {
                paypalBtnId.style.display = 'block'
              }

              }
            }
      
          </script>
          <!-- </button> -->
      </form>
    </div>
  </div>
  </div>


  <!-- Include the PayPal JavaScript SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id={{paypal_client_id}}&currency=USD"></script>

  <!-- create token -->
  <script>

    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    const total = '{{new_total | floatformat:2}}'
    const user = '{{user}}'
    const home_url = "{% url 'checkout-success' %}"
    console.log('user', user)
    console.log('total', total)
    

    function makepayment() {
      console.log('checkers csrftoken', csrftoken)
      const full_name = document.getElementById('full_name').value;
      const phone_number = document.getElementById('Phone_number').value;
      const reference = document.getElementById('reference').value
      const email = document.getElementById('email')?.value
      console.log('this is the referene inside payment', reference)
      const url = "{% url 'checkout' %}";
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-type': 'application/json',
          'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({ 'user': user, 'full_name': full_name, 'phone_number': phone_number, 'reference': reference,'email':email })
      })
      console.log(user)
      console.log('payment prcess alreay')
    }

    // Render the PayPal button into #paypal-button-container
    paypal.Buttons({

      // Set up the transaction
      createOrder: function (data, actions) {
        return actions.order.create({
          purchase_units: [{
            amount: {
              value: total
            }
          }]
        });
      },

      // Finalize the transaction
      onApprove: function (data, actions) {
        return actions.order.capture().then(function (details) {
          //Show a success message to the buyer
          makepayment()
           window.location.href = home_url;
          alert('Transaction completed by ' + details.payer.name.given_name + '!')
        });
      }

    }).render('#paypal-button-container');

  </script>
</section>

{% endblock content %}