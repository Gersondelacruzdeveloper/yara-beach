{% extends 'excursions/excursions_base.html' %}
<title>{% block title %}excursions in bavaro punta cana {% endblock %}</title>
{% load static %}

{% block content %}
<style>
  #paypal-button-container {
      display: none;
  }
</style>
<section>
    <h1 class="text-center mt-5">Checkout With   <img src="{% static 'images/paypal-logo.png' %}" class="paypal-logo" alt="Small Image"></h1>
    <div class="row" style="margin-bottom: 100px;">

      <div class="col-75"> 
        <div class="container">
          <div class="row">
            <!-- form -->
          <form action="/action_page.php" id="myForm">
            {% csrf_token %}
            <div class="row">
              <div class="col-50">
                <h3>Billing Address</h3>
                  <!-- Full Name -->
               <label for="full_name"><i class="fa fa-user"></i> Full Name</label>
                <input type="text" id="full_name" name="full_name" placeholder="John M. Doe" required>
                 Email 
                <label for="email"><i class="fa fa-envelope"></i> Email</label>
                <input type="text" id="email" name="email" placeholder="john@example.com" required>
                 <!-- phone number -->
                <label for="Phone_number"><i class="fa fa-phone"></i> Phone number</label>
                <input type="text" id="Phone_number" name="Phone_number" placeholder="07541147634" required>
              </div>
            </div>
          </form>

             <!-- paypal -->
             <div class="mt-5"> 
              <div class="container">
                <div  id="paypal-button-container"></div>
              </div>
            </div>

         </div>
        </div>
      </div> 
  
      <div class="col-25">
        <div class="container">
          <h4>Cart <span class="price" style="color:black"><i class="fa fa-shopping-cart"></i> <b>{{cart_items| length}}</b></span></h4>
          {% for item in cart_items %}
          <h6 class="my-0" style="font-weight: bolder;">
            {{item.excursion.title|slice:":25"|title}}
            <span class="price"> ${{item.subTotal | floatformat:2}}</span>
          </h6>
          <small><img class="cart-detail-img" src="{{item.excursion.main_image.url}}"
            alt="{{item.excursion.image_name}}"></small>
            {% if item.values.adult_qty %}
            <div class="pt-2"><i class="fa-solid fa-user"></i> Adult: {{item.values.adult_qty}}</div>
            {% endif%}
            {% if item.values.child_qty %}
            <div class="pt-2"> <i class="fa-solid fa-child"></i> Child: {{item.values.child_qty}}</div>
            {% endif%}
            <div clas="pt-2">
              <i class="fa-solid fa-calendar-days"></i> {{item.values.excursion_date}}
            </div>
            <div clas="pt-2">
              <i class="fa-solid fa-clock"></i> Time: {{item.values.selected_time}}
            </div>
          <hr>
          {% endfor%}

          <!-- for for applying the discount code -->
          <form method="POST" action="{% url 'apply_discount' %}">
            {% csrf_token %}
            <div class="">
              <input type="text" class="form-control" id="reference" name="reference" placeholder="Enter Promo code"
                maxlength="6" required>
               <button id="apply" class=" form-control btn my_hover btn-outline-secondary">Apply Promo code</button>
            </div>
        </form>
          <hr>
          <!-- price details -->
          <!-- <p>SubTotal <span class="price" style="color:black"><b>${{subtotal | floatformat:2}}</b></span></p> -->
          <p>Taxes<span class="price" style="color:grey"><b>${{taxes_and_fees|floatformat:2}}</b></span></p>
          <p>Total <span class="price" style="color:black"><b>${{m_total|floatformat:2}}</b></span></p>
          {% if not discount %}
          <li class="list-group-item d-flex justify-content-between">
            <span>Reserve now:</span>
            <strong style="color:green">${{charge_amount| floatformat:2}}</strong>
          </li>
          {% endif %}

          {% if discount > 0 %}
          <li class="list-group-item d-flex justify-content-between">
            <span>Discount</span>
            <strong>${{discount | floatformat:2}}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Final Total (US)</span>
            <strong>${{my_new_total | floatformat:2}}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Reserve now:</span>
            <strong style="color:green">${{charge_amount| floatformat:2}}</strong>
          </li>
          {% endif %}
       


        
          </b></span></p>
        </div>
      </div>
    </div>

  <!-- Include the PayPal JavaScript SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id={{paypal_client_id}}&currency=USD"></script>
<script>
function areAllFieldsFilled() {
        var fields = document.querySelectorAll('#myForm input[required]');
        for (var i = 0; i < fields.length; i++) {
            if (!fields[i].value) {
                return false;
            }
        }
        return true;
}

    // Function to toggle the display of the PayPal button
    function togglePayPalButton() {
        var paypalButtonContainer = document.getElementById('paypal-button-container');
        if (areAllFieldsFilled()) {
            paypalButtonContainer.style.display = 'block';
        } else {
            paypalButtonContainer.style.display = 'none';
        }
    }

     // Function to get all form values
     function getFormValues() {
        var formData = {};
        var formElements = document.querySelectorAll('#myForm input');
        formElements.forEach(function(element) {
            formData[element.name] = element.value;
        });
        return formData;
    }

    // Event listener to check form fields on input change
    var formInputs = document.querySelectorAll('#myForm input[required]');
    formInputs.forEach(function(input) {
        input.addEventListener('input', function() {
            togglePayPalButton();
            var formValues = getFormValues();
            console.log(formValues); // Log form values to the console
        });
    });


    const csrftoken = getCookie('csrftoken');
    const total = '{{new_total | floatformat:2}}'
    const anticipo = '{{charge_amount| floatformat:2}}'
    const user = '{{user}}'
    const home_url = "{% url 'checkout-success' %}"
    console.log('anticipo', anticipo)


    // Make payment function
    function makepayment() {
        const full_name = document.getElementById('full_name')?.value;
        const phone_number = document.getElementById('Phone_number')?.value;
        const reference = document.getElementById('reference')?.value;
        const email = document.getElementById('email')?.value;
        console.log('this is the reference inside payment', reference)
        const url = "{% url 'checkout' %}";
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({ 'user': user, 'full_name': full_name, 'phone_number': phone_number, 'reference': reference, 'email': email })
        });
        console.log(user);
        console.log('payment process already');
    }

    // Render the PayPal button into #paypal-button-container
    paypal.Buttons({
        // Set up the transaction
        createOrder: function (data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: parseFloat(anticipo)
                    }
                }]
            });
        },
        // Finalize the transaction
        onApprove: function (data, actions) {
            return actions.order.capture().then(function (details) {
                // Show a success message to the buyer
                makepayment();
                window.location.href = home_url;
            });
        }
    }).render('#paypal-button-container');
</script>

</section>

{% endblock content %}