{% extends 'excursions/excursions_base.html' %}
<title>{% block title %}excursions in bavaro punta cana {% endblock %}</title>
{% load static %}

{% block content %}

<section>
  <div class="container mb-2">
    <h1 class="text-center mt-5">Checkout</h1>
    <div class="row">
      <!-- what is in the cart -->
      <div class="col-md-4 order-md-2 mb-4">
        <h4 class="d-flex justify-content-between align-items-center mb-3">
          <span class="text-muted">Your cart</span>
          <span class="badge bg-site-color badge-pill">{{cart_items| length}}</span>
        </h4>
        <ul class="list-group mb-3">
          {% for item in cart_items %}
          <li class="list-group-item d-flex justify-content-between lh-condensed">
            <div>
              <h6 class="my-0" style="font-weight: bolder;">{{item.excursion.title|slice:":25"|title}}</h6>
              <div class="pt-3">
                <small><img class="cart-detail-img" src="{{item.excursion.main_image.url}}"
                    alt="{{item.excursion.image_name}}"></small>
              </div>
              {% if item.values.adult_qty %}
              <div class="pt-2"><i class="fa-solid fa-user"></i> Adult: {{item.values.adult_qty}}</div>
              {% endif%}

              {% if item.values.child_qty %}
              <div class="pt-2"> <i class="fa-solid fa-child"></i> Child: {{item.values.child_qty}}</div>
              {% endif%}
              {% if item.values.infant_qty %}
              <i class="fa-solid fa-baby-carriage"></i> <div class="pt-2">Infant: {{item.values.infant_qty}}</div>
              {% endif%}
              <div clas="pt-2">
                <i class="fa-solid fa-calendar-days"></i> Date: {{item.values.excursion_date}}
              </div>
              <div clas="pt-3">
                <i class="fa-solid fa-clock"></i> Time: {{item.values.selected_time}}
              </div>
              <div class="pt-2">
                 <p><i class="fa-solid fa-circle-check" style="color:green;"></i> Free Cancellation</p>
            </div>
            <span class="text-muted">${{item.subTotal | floatformat:2}}</span>
          </li>
      
          <li class="list-group-item d-flex justify-content-between">
            <span>Total (US)</span>
            <strong>${{total | floatformat:2}}</strong>
            <p style="color: green">All taxes and fees included</p>
          </li>

          {% if total_discount != 0%}
          <li class="list-group-item d-flex justify-content-between">
            <span>Discount</span>
            <strong>${{total_discount | floatformat:2}}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Final Total (US)</span>
            <strong>${{new_total | floatformat:2}}</strong>
          </li>
          {% endif%}
  

          <!-- session_discount -->
          <!-- card icons -->
          <div class="text-center list-group-item ">
            <i class="fa fa-cc-visa visa"></i>
            <i class="fa fa-cc-amex amex"></i>
            <i class="fa fa-cc-mastercard mastercard"></i>
            <i class="fa fa-cc-discover discover"></i>
          </div>
        </ul>

        <!-- form for updating quantity-->
        {% if item.excursion.dicount %}
      <form method="POST" action="{% url 'apply_discount' %}">
        {% csrf_token %}
        <div class="col-md-6 mb-3 list-group-item">
          <label for="reference">Discount Code</label>
          <input type="text" class="form-control" id="reference" name="reference" placeholder="Enter Promo code"
            maxlength="6" required>
        </div>
        <div class="col-md-6 mb-3 list-group-item">
          <label for="apply">Apply Discount Code</label>
          <button id="apply" class=" form-control btn my_hover btn-outline-secondary">Apply</button>
        </div>
    </div>
    </form>
    {% endif %}
      </div>
      {% endfor %}

    <!-- card pytments infomation -->
    <div class="col-md-8 order-md-1">
      <h4 class="mb-3 text-center">Provide your personal information</h4>
      <p style="color:green; text-align: center;"><i class="fa-solid fa-lock"></i> Checkout is fast and secure with Paypal</p>
      <form action=" " method="POST" id="payment-form">
        {% csrf_token %}
        <div class="row payments-container">
          <div class="col-md-6 mb-3">
            <label for="full_name">Full name *</label>
            <input type="text" class="form-control" id="full_name" name="full_name"
              placeholder="Full Name" required>
          </div>

          <div class="col-md-6 mb-3">
            <label for="Phone_number">Phone number</label>
            <input  type="text" class="form-control" id="Phone_number" name="Phone_number"
              placeholder="Phone number" required>
          </div>
          {% if not request.user.is_authenticated %}
          <div class="col-md-12 mb-3">
            <label for="email">Email</label>
            <input  type="text" class="form-control" id="email" name="email"
              placeholder="Email" required>
          </div>
          {%endif%}
          <hr class="mb-4">
          <div id="paypal-button-container"></div>
          <p class="p-3"><i class="fa-solid fa-circle-check" style="color:green;"></i> Free Cancellation</p>
          <script>
            // let continues = document.getElementById('continue')
            // let paypalBtnId = document.getElementById('paypal-button-container')
            // paypalBtnId.style.display = "none"
            // Initialize a counter variable to keep track of the function calls
            let functionCallCount = 0;
            const full_name = document.getElementById('full_name').value;
            const phone_number = document.getElementById('Phone_number').value;
            const email = document.getElementById('email')?.value;
            const get_user = '{{request.user}}'
            // function myFunction() {
            //   functionCallCount++
            //   if(get_user != 'AnonymousUser'){
            //     if (functionCallCount == 2) {
            //     paypalBtnId.style.display = 'block'
            //   }
            //   }else{
            //     if (functionCallCount == 3) {
            //     paypalBtnId.style.display = 'block'
            //   }

            //   }
            // }
      
          </script>
          <!-- </button> -->
      </form>
    </div>
  </div>
  </div>


  <!-- Include the PayPal JavaScript SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id={{paypal_client_id}}&currency=USD"></script>

  <!-- create token -->
  <script>

    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    const total = '{{new_total | floatformat:2}}'
    const user = '{{user}}'
    const home_url = "{% url 'checkout-success' %}"
    console.log('user', user)
    console.log('total', total)
    

    function makepayment() {
      console.log('checkers csrftoken', csrftoken)
      const full_name = document.getElementById('full_name').value;
      const phone_number = document.getElementById('Phone_number').value;
      const reference = document.getElementById('reference').value
      const email = document.getElementById('email')?.value
      console.log('this is the referene inside payment', reference)
      const url = "{% url 'checkout' %}";
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-type': 'application/json',
          'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({ 'user': user, 'full_name': full_name, 'phone_number': phone_number, 'reference': reference,'email':email })
      })
      console.log(user)
      console.log('payment prcess alreay')
    }

    // Render the PayPal button into #paypal-button-container
    paypal.Buttons({

      // Set up the transaction
      createOrder: function (data, actions) {
        return actions.order.create({
          purchase_units: [{
            amount: {
              value: total
            }
          }]
        });
      },

      // Finalize the transaction
      onApprove: function (data, actions) {
        return actions.order.capture().then(function (details) {
          //Show a success message to the buyer
          makepayment()
           window.location.href = home_url;
          alert('Transaction completed by ' + details.payer.name.given_name + '!')
        });
      }

    }).render('#paypal-button-container');

  </script>
</section>

{% endblock content %}